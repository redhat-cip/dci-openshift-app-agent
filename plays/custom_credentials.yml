---
# TODOs:
# - Define a better tmp file for users.htpasswd OR
#   evaluate how feasible is to use dci_cluster_configs_dir/users.htpasswd
#   (may not be good idea if multiple users could be created in the cluster at the same time)
# - Define a user name dynamically?
# - Use a proper location for doaa_kubeconfig
# - Find a way to rename the cluster in doaa_kubeconfig once created as it uses the <server> by default

- name: "Extract cluster name and server"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  shell: >
    oc config view -o jsonpath="{.clusters[0].cluster.server}"
  register: server

- name: "Extract htpasswd secret"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  shell: >
    oc --namespace openshift-config \
      get secret htpass-secret \
      -o jsonpath='{.data.htpasswd}' |
    base64 -d > /tmp/users.htpasswd

- name: "Add new user creds to htpasswd secret"
  shell: >
    htpasswd -bB /tmp/users.htpasswd doaa doaa

- name: "Update htpasswd secret"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  shell: >
    set -o pipefail;
    oc create secret generic htpass-secret \
      --from-file=htpasswd=/tmp/users.htpasswd \
      --namespace openshift-config \
      --dry-run=client --output yaml |
    oc apply -f -

- name: "Give admin role to the <doaa> user"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  shell: >
    oc adm policy add-role-to-user admin doaa

- name: Login with <doaa> user to create the doaa_kubeconfig file
  environment:
    KUBECONFIG: "/tmp/doaa_kubeconfig"
  shell: >
    oc login --insecure-skip-tls-verify=true -u doaa -p doaa {{ server.stdout }}
  retries: 10
  delay: 10
  register: result
  until: result.rc == 0

- name: Set new kubeconfig path
  set_fact:
    doaa_kubeconfig: "/tmp/doaa_kubeconfig"

...
