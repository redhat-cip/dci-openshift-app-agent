---
# TODOs:
# - Define a better tmp file for users.htpasswd OR
#   evaluate how feasible is to use dci_cluster_configs_dir/users.htpasswd
#   (may not be good idea if multiple users could be created in the cluster at the same time)
# - admin users can't create nor delete namespaces
#   - Either remove the creation/deletion of namespaces from the hook or find a diff set of permissions
#   - Remove the ns (and the user?) in a new play (play/teardown.yml?)

- name: "Define default user"
  set_fact:
    users:
      - name: doaa_user
        namespace: doaa-ns
  when: users is undefined

- name: "Create Namespaces"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  k8s:
    api_version: v1
    name: "{{ item.namespace }}"
    kind: Namespace
  loop: "{{ users }}"

- name: "Extract cluster name and server"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  shell: >
    oc config view -o jsonpath="{.clusters[0].cluster.server}"
  register: server

- name: "Extract htpasswd secret"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  shell: >
    oc --namespace openshift-config \
      get secret htpass-secret \
      -o jsonpath='{.data.htpasswd}' |
    base64 -d > /tmp/users.htpasswd

- name: Create random passwords for users
  set_fact:
    users_passwords: >
      {{ users_passwords | default([]) + [ {
        "name": item.name,
        "namespace": item.namespace,
        "password": lookup('password', '/dev/null chars=ascii_letters,digits')
        } ]
      }}
  loop: "{{ users }}"
  no_log: true

- name: "Add new user creds to htpasswd secret"
  shell: >
    htpasswd -bB /tmp/users.htpasswd {{ item.name }} {{ item.password }}
  loop: "{{ users_passwords }}"
  no_log: true

- name: "Update htpasswd secret"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  shell: >
    set -o pipefail;
    oc create secret generic htpass-secret \
      --from-file=htpasswd=/tmp/users.htpasswd \
      --namespace openshift-config \
      --dry-run=client --output yaml |
    oc apply -f -

- name: "Give admin role to the users"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  shell: >
    oc adm policy add-role-to-user admin {{ item.name }} -n {{ item.namespace }}
  loop: "{{ users }}"

- name: "Delete stale custom kubeconfig files"
  file:
    name: "{{ kubeconfig_path | dirname }}/{{ item.name }}_kubeconfig"
    state: absent
  loop: "{{ users }}"

- name: Login with each user to create their own kubeconfig file
  environment:
    KUBECONFIG: "{{ kubeconfig_path | dirname }}/{{ item.name }}_kubeconfig"
  shell: >
    oc login --insecure-skip-tls-verify=true -u {{ item.name }} -p {{ item.password }} -n {{ item.namespace }} {{ server.stdout }}
  retries: 10
  delay: 10
  register: result
  until: result.rc == 0
  loop: "{{ users_passwords }}"
  no_log: true

- name: "Set kubeconfig paths to user"
  set_fact:
    cluster_users: >
      {{ cluster_users | default([]) + [ {
        "name": item.name,
        "namespace": item.namespace,
        "kubeconfig": kubeconfig_path | dirname + "/" + item.name + "_kubeconfig"
        } ]
      }}
  loop: "{{ users }}"

- name: "Set default admin kubeconfig path"
  set_fact:
    admin_kubeconfig_path: "{{ cluster_users[0].kubeconfig }}"

...
