---
# TODOs:
# - Define a better tmp file for users.htpasswd OR
#   evaluate how feasible is to use dci_cluster_configs_dir/users.htpasswd
#   (may not be good idea if multiple users could be created in the cluster at the same time)
# - Define a user name dynamically?
# - Use a proper location for <user>_kubeconfig
# - Find a way to rename the cluster in <user>_kubeconfig once created as it uses the <server> by default

- name: "Define default user"
  set_fact:
    users:
      - name: doaa_user
      - namespace: doaa_ns
  when: users is undefined

- name: "Create Namespaces"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  k8s:
    api_version: v1
    name: "{{ item.namespace }}"
    kind: Namespace
  loop: "{{ users }}"

- name: "Extract cluster name and server"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  shell: >
    oc config view -o jsonpath="{.clusters[0].cluster.server}"
  register: server

- name: "Extract htpasswd secret"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  shell: >
    oc --namespace openshift-config \
      get secret htpass-secret \
      -o jsonpath='{.data.htpasswd}' |
    base64 -d > /tmp/users.htpasswd

- name: Create tmp passwords for users
  set_fact:
    tmp_users: >
      {{ tmp_users | default([]) + [ {
        "name": item.name,
        "namespace": item.namespace,
        "password": lookup('password', '/dev/null chars=ascii_letters,digits')
        } ]
      }}
  loop: "{{ users }}"
  no_log: true

- name: Add passwords to users
  set_fact:
    users: "{{ tmp_users }}"
  no_log: true

- name: "Add new user creds to htpasswd secret"
  shell: >
    htpasswd -bB /tmp/users.htpasswd {{ item.name }} {{ item.password }}
  loop: "{{ users }}"
  no_log: true

- name: "Update htpasswd secret"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  shell: >
    set -o pipefail;
    oc create secret generic htpass-secret \
      --from-file=htpasswd=/tmp/users.htpasswd \
      --namespace openshift-config \
      --dry-run=client --output yaml |
    oc apply -f -

- name: "Give admin role to the users"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  shell: >
    oc adm policy add-role-to-user admin {{ item.name }} -n {{ item.namespace }}
  loop: "{{ users }}"

- name: Login with each user to create their own user_kubeconfig file
  environment:
    KUBECONFIG: "/tmp/{{ item.name }}_kubeconfig"
  shell: >
    oc login --insecure-skip-tls-verify=true -u {{ item.name }} -p {{ item.password }} -n {{ item.namespace }} {{ server.stdout }}
  retries: 10
  delay: 10
  register: result
  until: result.rc == 0
  loop: "{{ users }}"

...
