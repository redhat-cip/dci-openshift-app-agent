---

- block:
    - name: "Upload {{ item.path | basename }} to DCI Control Server"
      environment:
        - DCI_CLIENT_ID: "{{ lookup('env','DCI_CLIENT_ID') }}"
        - DCI_API_SECRET: "{{ lookup('env','DCI_API_SECRET') }}"
        - DCI_CS_URL: "{{ lookup('env','DCI_CS_URL') }}"
      dci_file:
        path: "{{ item.path }}"
        name: "{{ item.path | basename }}"
        job_id: "{{ job_id }}"
        mime: "{{ mime_type }}"

  rescue:
    - name: "Create a local log directory"
      file:
        path: "{{ dci_local_log_dir }}/{{ job_id }}"
        state: directory
        mode: '0755'

    - name: "Copy {{ item.path | basename }} locally"
      copy:
        src: "{{ item.path }}"
        dest: "{{ dci_local_log_dir }}/{{ job_id }}/"
        mode: '0644'
...
